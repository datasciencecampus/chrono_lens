language: python

matrix:
  include:
    # Use the built in venv for linux builds
    - os: linux
      sudo: required
      python: "3.8.6"
      dist: xenial

install:
  - python3 --version
  - python3 -m pip install -U pip

script:
  #
  # --------------- localhost tests ---------------
  #
  - python3 -m venv localhost-venv
  - source localhost-venv/bin/activate

  # command to install dependencies
  #  - pip install --use-feature=2020-resolver -r requirements-localhost.txt
  # includes extra 'test' specific dependencies
  - pip3 install --use-feature=2020-resolver -r tests/requirements.txt
  # for codecov support
  - pip3 install pytest==4.3.1 pytest-cov==2.9.0
  # to report installed packages
  - pip3 freeze
  # command to run tests
  #  - PYTHONPATH=. pytest --cov-config .coveragerc --cov=./ tests/
  #  - deactivate


  #
  # --------------- gcloud chrono_lens tests ---------------
  #
  # pip removed when venv exited?
  #  - python3 -m pip install -U pip
  #  - sudo apt-get install python3-pip
  #  - sudo apt-get install python3-venv
  - python3 -m venv gcloud-venv
  - source gcloud-venv/bin/activate

  - which python3
  - which pip3
  - pip3 -V

  # Pretend we're running on GCP
  - GCP_PROJECT="Travis"
  - BUILD_ID="Travis"

  # command to install dependencies
  - pip3 install --use-feature=2020-resolver -r requirements-gcloud.txt
  # includes extra 'test' specific dependencies
  - pip3 install --use-feature=2020-resolver -r tests/requirements.txt
  # for codecov support
  - pip3 install pytest==4.3.1 pytest-cov==2.9.0
  # to report installed packages
  - pip3 freeze
  # command to run tests
  #  - cd tests
  #  - PYTHONPATH=.. pytest --cov-config ../.coveragerc --cov=../ ./
  #  - cd ..
  - PYTHONPATH=. pytest --cov-config .coveragerc --cov=./ tests/
  #  - deactivate


  #
  # --------------- gcloud cloud function tests ---------------
  #

  - cd cloud/functions

  # Find all subfolders with src, as these are the folders with GCP function code and create ci/cd triggers
  - |
    for repo_dir in **/src/
    do
      FUNCTION_NAME=${repo_dir%/*/} # get only base dir name e.g. distribute_json_sources/src/ -> distribute_json_sources
      echo
      echo "*** INFO Testing cloud function <${FUNCTION_NAME}> locally ***"
      echo
    #      sudo apt-get install python3-venv
      python3 -m venv ${FUNCTION_NAME}-venv
      source ${FUNCTION_NAME}-venv/bin/activate
      GCP_PROJECT="Travis"
      BUILD_ID="Travis"
      cd ${FUNCTION_NAME}
      echo "Copying root 'chrono_lens' folder as subdir to 'src' to enable local reuse of shared folder"
      cp -r ../../../chrono_lens src/
      pip3 install pytest
      pip3 install -r src/requirements.txt
      if [ -f "tests/requirements.txt" ]; then pip3 install -r tests/requirements.txt; fi
      cd src
      echo "GCP_PROJECT=$PROJECT_ID python -m pytest -v ../tests"
      GCP_PROJECT=$PROJECT_ID python -m pytest -v ../tests
      deactivate
    done



#  - # Now install requirements for dsc_lib
#  - pip install --use-feature=2020-resolver -r cloud/dsc_lib_tests/requirements.txt
#  - pip freeze
#  - cd cloud/dsc_lib
#  # ...and run the tests on dsc_lib
#  - PYTHONPATH=../..:.. pytest --cov-config .coveragerc --cov=./ ../dsc_lib_tests/

after_success:
  - bash <(curl -s https://codecov.io/bash)
